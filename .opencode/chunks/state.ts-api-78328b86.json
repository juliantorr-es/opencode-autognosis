{
  "id": "state.ts-api-78328b86",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-worktree/src/plugin/worktree/state.ts",
  "chunk_type": "api",
  "content": "# API Surface: state.ts\n\n## Public Functions\n\n### getWorktreePath\n```typescript\nexport async function getWorktreePath(projectRoot: string, branch: string): Promise<string>\n```\nGet the worktree path for a given project and branch.\n\n**Parameters:**\n- `projectRoot`: string - \n- `branch`: string - \n\n**Returns:** Promise<string>\n\n\n### initStateDb\n```typescript\nexport async function initStateDb(projectRoot: string): Promise<Database>\n```\nInitialize the SQLite database for worktree state.\nCreates the database file and schema if they don't exist.\n\n**Parameters:**\n- `projectRoot`: string - \n\n**Returns:** Promise<Database>\n\n\n### addSession\n```typescript\nexport function addSession(db: Database, session: Session): void\n```\nAdd a new session to the database.\nUses atomic INSERT OR REPLACE for idempotency.\n\n**Parameters:**\n- `db`: Database - \n- `session`: Session - \n\n**Returns:** void\n\n\n### getSession\n```typescript\nexport function getSession(db: Database, sessionId: string): Session | null\n```\nGet a session by ID.\n\n**Parameters:**\n- `db`: Database - \n- `sessionId`: string - \n\n**Returns:** Session | null\n\n\n### removeSession\n```typescript\nexport function removeSession(db: Database, branch: string): void\n```\nRemove a session by branch name.\nDeletes all sessions matching the branch.\n\n**Parameters:**\n- `db`: Database - \n- `branch`: string - \n\n**Returns:** void\n\n\n### getAllSessions\n```typescript\nexport function getAllSessions(db: Database): Session[]\n```\nGet all active sessions.\n\n**Parameters:**\n- `db`: Database - \n\n**Returns:** Session[]\n\n\n### setPendingSpawn\n```typescript\nexport function setPendingSpawn(db: Database, spawn: PendingSpawn, client?: OpencodeClient): void\n```\nSet a pending spawn operation. Uses singleton pattern (last-write-wins).\n\nIf a pending spawn already exists, it will be REPLACED and a warning logged.\nThis is intentional: only the most recent spawn request should be processed.\n\n**Parameters:**\n- `db`: Database - \n- `spawn`: PendingSpawn - \n- `client`: OpencodeClient - \n\n**Returns:** void\n\n\n### getPendingSpawn\n```typescript\nexport function getPendingSpawn(db: Database): PendingSpawn | null\n```\nGet the pending spawn operation if one exists.\n\n**Parameters:**\n- `db`: Database - \n\n**Returns:** PendingSpawn | null\n\n\n### clearPendingSpawn\n```typescript\nexport function clearPendingSpawn(db: Database): void\n```\nClear any pending spawn operation.\nRemoves the row if it's a spawn type, leaves deletes untouched.\n\n**Parameters:**\n- `db`: Database - \n\n**Returns:** void\n\n\n### setPendingDelete\n```typescript\nexport function setPendingDelete(db: Database, del: PendingDelete, client?: OpencodeClient): void\n```\nSet a pending delete operation. Uses singleton pattern (last-write-wins).\n\nIf a pending delete already exists, it will be REPLACED and a warning logged.\nThis is intentional: only the most recent delete request should be processed.\n\n**Parameters:**\n- `db`: Database - \n- `del`: PendingDelete - \n- `client`: OpencodeClient - \n\n**Returns:** void\n\n\n### getPendingDelete\n```typescript\nexport function getPendingDelete(db: Database): PendingDelete | null\n```\nGet the pending delete operation if one exists.\n\n**Parameters:**\n- `db`: Database - \n\n**Returns:** PendingDelete | null\n\n\n### clearPendingDelete\n```typescript\nexport function clearPendingDelete(db: Database): void\n```\nClear any pending delete operation.\nRemoves the row if it's a delete type, leaves spawns untouched.\n\n**Parameters:**\n- `db`: Database - \n\n**Returns:** void\n\n\n## Classes\n\n\n## Interfaces\n\n### Session\n```typescript\nexport interface Session\n```\nRepresents an active worktree session\n\n\n### PendingSpawn\n```typescript\nexport interface PendingSpawn\n```\nPending spawn operation to be processed on session.idle\n\n\n### PendingDelete\n```typescript\nexport interface PendingDelete\n```\nPending delete operation to be processed on session.idle\n\n\n## Types\n",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.386Z",
    "updated_at": "2026-01-30T05:26:52.386Z",
    "hash": "8f1f17081fd68e30b3c67ffb013f45c2d51c324c9be603311e82befc8ecacd41",
    "dependencies": [
      "bun:sqlite",
      "node:fs",
      "node:os",
      "node:path",
      "zod",
      "../kdco-primitives",
      "../kdco-primitives"
    ],
    "symbols": [
      "Session",
      "PendingSpawn",
      "PendingDelete",
      "sessionSchema",
      "pendingSpawnSchema",
      "pendingDeleteSchema",
      "getWorktreePath",
      "projectId",
      "getDbDirectory",
      "home",
      "getDbPath",
      "projectId",
      "initStateDb",
      "dbPath",
      "dbDir",
      "db",
      "addSession",
      "parsed",
      "stmt",
      "getSession",
      "stmt",
      "row",
      "removeSession",
      "stmt",
      "getAllSessions",
      "stmt",
      "rows",
      "setPendingSpawn",
      "parsed",
      "existingSpawn",
      "existingDelete",
      "stmt",
      "getPendingSpawn",
      "stmt",
      "row",
      "clearPendingSpawn",
      "stmt",
      "setPendingDelete",
      "parsed",
      "existingDelete",
      "existingSpawn",
      "stmt",
      "getPendingDelete",
      "stmt",
      "row",
      "clearPendingDelete",
      "stmt"
    ],
    "complexity_score": 100
  }
}