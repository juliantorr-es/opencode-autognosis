{
  "id": "gemini.ts-invariant-dd4f6e2b",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-google-antigravity-auth/src/plugin/transform/gemini.ts",
  "chunk_type": "invariant",
  "content": "# Invariants: gemini.ts\n\n## Core Invariants\n\n\n## Constraints\n- **THOUGHT_SIGNATURE_BYPASS**: \"skip_thought_signature_validator\"\n- **GEMINI_TOOL_SCHEMA_SYSTEM_INSTRUCTION**: `<CRITICAL_TOOL_USAGE_INSTRUCTIONS>\nYou are operating in a CUSTOM ENVIRONMENT where tool definitions COMPLETELY DIFFER from your training data.\nVIOLATION OF THESE RULES WILL CAUSE IMMEDIATE SYSTEM FAILURE.\n\n## ABSOLUTE RULES - NO EXCEPTIONS\n\n1. **SCHEMA IS LAW**: The JSON schema in each tool definition is the ONLY source of truth.\n   - Your pre-trained knowledge about tools like 'read_file', 'apply_diff', 'write_to_file', 'bash', etc. is INVALID here.\n   - Every tool has been REDEFINED with different parameters than what you learned during training.\n\n2. **PARAMETER NAMES ARE EXACT**: Use ONLY the parameter names from the schema.\n   - WRONG: 'suggested_answers', 'file_path', 'files_to_read', 'command_to_run'\n   - RIGHT: Check the 'properties' field in the schema for the exact names\n   - The schema's 'required' array tells you which parameters are mandatory\n\n3. **ARRAY PARAMETERS**: When a parameter has \"type\": \"array\", check the 'items' field:\n   - If items.type is \"object\", you MUST provide an array of objects with the EXACT properties listed\n   - If items.type is \"string\", you MUST provide an array of strings\n   - NEVER provide a single object when an array is expected\n   - NEVER provide an array when a single value is expected\n\n4. **NESTED OBJECTS**: When items.type is \"object\":\n   - Check items.properties for the EXACT field names required\n   - Check items.required for which nested fields are mandatory\n   - Include ALL required nested fields in EVERY array element\n\n5. **STRICT PARAMETERS HINT**: Tool descriptions contain \"STRICT PARAMETERS: ...\" which lists:\n   - Parameter name, type, and whether REQUIRED\n   - For arrays of objects: the nested structure in brackets like [field: type REQUIRED, ...]\n   - USE THIS as your quick reference, but the JSON schema is authoritative\n\n6. **BEFORE EVERY TOOL CALL**:\n   a. Read the tool's 'parametersJsonSchema' or 'parameters' field completely\n   b. Identify ALL required parameters\n   c. Verify your parameter names match EXACTLY (case-sensitive)\n   d. For arrays, verify you're providing the correct item structure\n   e. Do NOT add parameters that don't exist in the schema\n\n## COMMON FAILURE PATTERNS TO AVOID\n\n- Using 'path' when schema says 'filePath' (or vice versa)\n- Using 'content' when schema says 'text' (or vice versa)  \n- Providing {\"file\": \"...\"} when schema wants [{\"path\": \"...\", \"line_ranges\": [...]}]\n- Omitting required nested fields in array items\n- Adding 'additionalProperties' that the schema doesn't define\n- Guessing parameter names from similar tools you know from training\n\n## REMEMBER\nYour training data about function calling is OUTDATED for this environment.\nThe tool names may look familiar, but the schemas are DIFFERENT.\nWhen in doubt, RE-READ THE SCHEMA before making the call.\n</CRITICAL_TOOL_USAGE_INSTRUCTIONS>\n\n## GEMINI 3 RESPONSE RULES\n- Default to a direct, concise answer\n\n## Assumptions\n\n\n## State Management\nNo explicit state management patterns detected\n\n## Error Handling\nNo explicit error handling patterns detected\n\n## Performance Considerations\nPerformance patterns: Contains explicit loops\n\n## Security Considerations\nNo obvious security risks detected via static analysis",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.258Z",
    "updated_at": "2026-01-30T05:26:52.258Z",
    "hash": "af6268a95885e0b14e164d1e98220c6cd360dfaa9c2d7cef96d6d7c2a70e63b1",
    "dependencies": [
      "../cache",
      "../logger",
      "../request-helpers",
      "../tool-schema-cache",
      "./types"
    ],
    "symbols": [
      "log",
      "THOUGHT_SIGNATURE_BYPASS",
      "GEMINI_TOOL_SCHEMA_SYSTEM_INSTRUCTION",
      "hasFunctionTools",
      "tools",
      "extractSystemInstructionText",
      "parts",
      "getToolCallingMode",
      "toolConfig",
      "functionCallingConfig",
      "mode",
      "getFunctionToolNames",
      "tools",
      "names",
      "tool",
      "funcDecls",
      "funcDecl",
      "name",
      "hasInjectedToolSchemaInstruction",
      "existingText",
      "ScrubResult",
      "scrubToolTranscriptArtifacts",
      "lines",
      "output",
      "removedLines",
      "removedBlocks",
      "inFence",
      "fenceStart",
      "fenceLines",
      "isMarkerLine",
      "line",
      "isFence",
      "hadMarker",
      "cleanedFenceLines",
      "fenceLine",
      "hasNonWhitespace",
      "cleaned",
      "scrubConversationArtifactsFromModelHistory",
      "contents",
      "scrubbedParts",
      "removedLines",
      "removedBlocks",
      "content",
      "parts",
      "part",
      "scrubbed",
      "injectSystemInstructionIfNeeded",
      "existingText",
      "existing",
      "suffix",
      "asRecord",
      "parts",
      "normalizeSchemaType",
      "nonNull",
      "first",
      "summarizeSchema",
      "record",
      "normalizedType",
      "enumValues",
      "items",
      "itemSummary",
      "props",
      "required",
      "keys",
      "requiredKeys",
      "optionalKeys",
      "orderedKeys",
      "maxPropsToShow",
      "shownKeys",
      "inner",
      "propSchema",
      "propType",
      "requiredSuffix",
      "extraCount",
      "extra",
      "preview",
      "suffix",
      "buildStrictParamsSummary",
      "schemaType",
      "properties",
      "required",
      "keys",
      "requiredKeys",
      "optionalKeys",
      "orderedKeys",
      "parts",
      "propSchema",
      "typeSummary",
      "requiredSuffix",
      "summary",
      "maxLen",
      "augmentToolDescriptionsWithStrictParams",
      "tools",
      "augmented",
      "toolNames",
      "tool",
      "funcDecls",
      "funcDecl",
      "schema",
      "currentDescription",
      "summary",
      "nextDescription",
      "sanitizeToolNameForGemini",
      "sanitizeToolNames",
      "tools",
      "tool",
      "funcDecls",
      "func",
      "originalName",
      "transformGeminiRequest",
      "requestPayload",
      "toolConfig",
      "rawGenerationConfig",
      "normalizedThinking",
      "cachedContentFromExtra",
      "cachedContent",
      "contents",
      "contentIndex",
      "content",
      "parts",
      "filteredParts",
      "thinkingBlocksRemoved",
      "removedThoughtSignatures",
      "addedFunctionCallThoughtSignatures",
      "currentThoughtSignature",
      "partIndex",
      "part",
      "thoughtText",
      "cachedSig",
      "functionCall",
      "callName",
      "existingSig",
      "source",
      "nextSig",
      "wrappedBody",
      "toolCount",
      "toolCallingMode",
      "systemInstructionHasMarker",
      "functionToolNames",
      "contentsCount",
      "body",
      "countTools",
      "tools",
      "count",
      "tool",
      "funcDecls"
    ],
    "complexity_score": 100
  }
}