{
  "id": "worktree.ts-summary-c22e092a",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-worktree/src/plugin/worktree.ts",
  "chunk_type": "summary",
  "content": "# Summary: worktree.ts\n\n## File Type\n.ts - TypeScript source file\n\n## Purpose\nDocumented purpose found in JSDoc\n\n## Key Components\n\n### Functions (17)\n- **isValidBranchName**: Git branch name validation - blocks invalid refs and shell metacharacters\nCharacters blocked: control chars (0x00-0x1f, 0x7f), ~^:?*[]\\\\, and shell metacharacters\n- **pathExists**: Check if a path exists, distinguishing ENOENT from other errors (Law 4)\n- **copyIfExists**: Copy file if source exists. Returns true if copied, false if source doesn't exist.\nThrows on copy failure (Law 4: Fail Loud)\n- **copyDirIfExists**: Copy directory contents if source exists.\n- **forkWithContext**: Fork a session and copy associated plans/delegations.\nCleans up forked session on failure (atomic operation).\n- **registerCleanupHandlers**: Register process cleanup handlers for graceful database shutdown.\nEnsures WAL checkpoint and proper close on process termination.\n\nNOTE: process.once() is an EventEmitter method that never throws.\nThe boolean guard is defense-in-depth for idempotency, not error recovery.\n- **getDb**: Get the database instance, initializing if needed.\nIncludes retry logic for transient initialization failures.\n- **initDb**: Initialize the database with the project root path.\nMust be called once before any getDb() calls.\n- **git**: Execute a git command safely using Bun.spawn with explicit array.\nAvoids shell interpolation entirely by passing args as array.\n- **branchExists**: No documentation found\n- **createWorktree**: No documentation found\n- **removeWorktree**: No documentation found\n- **isPathSafe**: Validate that a path is safe (no escape from base directory)\n- **copyFiles**: Copy files from source directory to target directory.\nSkips missing files silently (production pattern).\n- **symlinkDirs**: Create symlinks for directories from source to target.\nUses absolute paths for symlink targets.\n- **runHooks**: Run hook commands in the worktree directory.\n- **loadWorktreeConfig**: Load worktree-specific configuration from .opencode/worktree.jsonc\nAuto-creates config file with helpful defaults if it doesn't exist.\n\n\n\n### Classes (1)\n- **WorktreeError**: No documentation found\n\n\n## Dependencies\n- bun:sqlite\n- node:fs/promises\n- node:os\n- node:path\n- @opencode-ai/plugin\n- @opencode-ai/sdk\n- ./kdco-primitives/types\n- jsonc-parser\n- zod\n- ./kdco-primitives/get-project-id\n- ./worktree/state\n- ./worktree/terminal\n\n## Exports\n- WorktreePlugin\n\n## Complexity Metrics\n- Lines of code: 862\n- Estimated complexity: 100/100\n\n## Notes\nNo specific notes found",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.398Z",
    "updated_at": "2026-01-30T05:26:52.398Z",
    "hash": "261c3365f60e2e1bdd74c0b8bbeaa1e7127b762fbb0c3611edf93777ae579d87",
    "dependencies": [
      "bun:sqlite",
      "node:fs/promises",
      "node:os",
      "node:path",
      "@opencode-ai/plugin",
      "@opencode-ai/sdk",
      "./kdco-primitives/types",
      "jsonc-parser",
      "zod",
      "./kdco-primitives/get-project-id",
      "./worktree/state",
      "./worktree/terminal"
    ],
    "symbols": [
      "Logger",
      "DB_MAX_RETRIES",
      "DB_RETRY_DELAY_MS",
      "MAX_SESSION_CHAIN_DEPTH",
      "OkResult",
      "ErrResult",
      "Result",
      "Result",
      "isValidBranchName",
      "i",
      "code",
      "branchNameSchema",
      "worktreeConfigSchema",
      "WorktreeConfig",
      "WorktreeError",
      "pathExists",
      "e",
      "copyIfExists",
      "copyDirIfExists",
      "ForkResult",
      "forkWithContext",
      "rootSessionId",
      "e",
      "forkedSessionResponse",
      "forkedSession",
      "planCopied",
      "delegationsCopied",
      "workspaceBase",
      "delegationsBase",
      "destWorkspaceDir",
      "destDelegationsDir",
      "srcPlan",
      "destPlan",
      "srcDelegations",
      "error",
      "workspaceBase",
      "delegationsBase",
      "destWorkspaceDir",
      "destDelegationsDir",
      "db",
      "projectRoot",
      "cleanupRegistered",
      "registerCleanupHandlers",
      "cleanup",
      "getDb",
      "lastError",
      "attempt",
      "error",
      "initDb",
      "git",
      "proc",
      "error",
      "branchExists",
      "result",
      "createWorktree",
      "worktreePath",
      "exists",
      "result",
      "base",
      "result",
      "removeWorktree",
      "result",
      "isPathSafe",
      "resolved",
      "copyFiles",
      "file",
      "sourcePath",
      "targetPath",
      "sourceFile",
      "targetFileDir",
      "error",
      "isNotFound",
      "symlinkDirs",
      "dir",
      "sourcePath",
      "targetPath",
      "fileStat",
      "targetParentDir",
      "error",
      "runHooks",
      "command",
      "result",
      "stderr",
      "error",
      "loadWorktreeConfig",
      "configPath",
      "file",
      "defaultConfig",
      "content",
      "parsed",
      "error",
      "WorktreePlugin",
      "log",
      "database",
      "branchResult",
      "baseResult",
      "result",
      "worktreePath",
      "worktreeConfig",
      "mainWorktreePath",
      "projectId",
      "currentId",
      "depth",
      "session",
      "terminalResult",
      "session",
      "pendingDelete",
      "config",
      "addResult",
      "commitResult",
      "removeResult"
    ],
    "complexity_score": 100
  }
}