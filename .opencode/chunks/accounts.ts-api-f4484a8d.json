{
  "id": "accounts.ts-api-f4484a8d",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-antigravity-auth/src/plugin/accounts.ts",
  "chunk_type": "api",
  "content": "# API Surface: accounts.ts\n\n## Public Functions\n\n### parseRateLimitReason\n```typescript\nexport function parseRateLimitReason(reason?: string, message?: string): RateLimitReason\n```\nNo documentation found\n\n**Parameters:**\n- `reason`: string - \n- `message`: string - \n\n**Returns:** RateLimitReason\n\n\n### calculateBackoffMs\n```typescript\nexport function calculateBackoffMs(\n  reason: RateLimitReason,\n  consecutiveFailures: number,\n  retryAfterMs?: number | null\n): number\n```\nNo documentation found\n\n**Parameters:**\n- `reason`: RateLimitReason - \n- `consecutiveFailures`: number - \n- `retryAfterMs`: number | null - \n\n**Returns:** number\n\n\n## Classes\n\n### AccountManager\n```typescript\nexport class AccountManager\n```\nIn-memory multi-account manager with sticky account selection.\n\nUses the same account until it hits a rate limit (429), then switches.\nRate limits are tracked per-model-family (claude/gemini) so an account\nrate-limited for Claude can still be used for Gemini.\n\nSource of truth for the pool is `antigravity-accounts.json`.\n\n**Methods:**\n- `loadFromDisk`: static async loadFromDisk(authFallback?: OAuthAuthDetails): Promise<AccountManager>\n- `getAccountCount`: getAccountCount(): number\n- `getAccountsSnapshot`: getAccountsSnapshot(): ManagedAccount[]\n- `getCurrentAccountForFamily`: getCurrentAccountForFamily(family: ModelFamily): ManagedAccount | null\n- `markSwitched`: markSwitched(account: ManagedAccount, reason: \"rate-limit\" | \"initial\" | \"rotation\", family: ModelFamily): void\n- `shouldShowAccountToast`: shouldShowAccountToast(accountIndex: number, debounceMs = 30000): boolean\n- `markToastShown`: markToastShown(accountIndex: number): void\n- `getCurrentOrNextForFamily`: getCurrentOrNextForFamily(\n    family: ModelFamily, \n    model?: string | null,\n    strategy: AccountSelectionStrategy = 'sticky',\n    headerStyle: HeaderStyle = 'antigravity',\n    pidOffsetEnabled: boolean = false,\n  ): ManagedAccount | null\n- `getNextForFamily`: getNextForFamily(family: ModelFamily, model?: string | null, headerStyle: HeaderStyle = \"antigravity\"): ManagedAccount | null\n- `markRateLimited`: markRateLimited(\n    account: ManagedAccount,\n    retryAfterMs: number,\n    family: ModelFamily,\n    headerStyle: HeaderStyle = \"antigravity\",\n    model?: string | null\n  ): void\n- `markRateLimitedWithReason`: markRateLimitedWithReason(\n    account: ManagedAccount,\n    family: ModelFamily,\n    headerStyle: HeaderStyle,\n    model: string | null | undefined,\n    reason: RateLimitReason,\n    retryAfterMs?: number | null\n  ): number\n- `markRequestSuccess`: markRequestSuccess(account: ManagedAccount): void\n- `clearAllRateLimitsForFamily`: clearAllRateLimitsForFamily(family: ModelFamily, model?: string | null): void\n- `shouldTryOptimisticReset`: shouldTryOptimisticReset(family: ModelFamily, model?: string | null): boolean\n- `markAccountCoolingDown`: markAccountCoolingDown(account: ManagedAccount, cooldownMs: number, reason: CooldownReason): void\n- `isAccountCoolingDown`: isAccountCoolingDown(account: ManagedAccount): boolean\n- `clearAccountCooldown`: clearAccountCooldown(account: ManagedAccount): void\n- `getAccountCooldownReason`: getAccountCooldownReason(account: ManagedAccount): CooldownReason | undefined\n- `markTouchedForQuota`: markTouchedForQuota(account: ManagedAccount, quotaKey: string): void\n- `isFreshForQuota`: isFreshForQuota(account: ManagedAccount, quotaKey: string): boolean\n- `getFreshAccountsForQuota`: getFreshAccountsForQuota(quotaKey: string, family: ModelFamily, model?: string | null): ManagedAccount[]\n- `isRateLimitedForHeaderStyle`: isRateLimitedForHeaderStyle(\n    account: ManagedAccount,\n    family: ModelFamily,\n    headerStyle: HeaderStyle,\n    model?: string | null\n  ): boolean\n- `getAvailableHeaderStyle`: getAvailableHeaderStyle(account: ManagedAccount, family: ModelFamily, model?: string | null): HeaderStyle | null\n- `removeAccount`: removeAccount(account: ManagedAccount): boolean\n- `updateFromAuth`: updateFromAuth(account: ManagedAccount, auth: OAuthAuthDetails): void\n- `toAuthDetails`: toAuthDetails(account: ManagedAccount): OAuthAuthDetails\n- `getMinWaitTimeForFamily`: getMinWaitTimeForFamily(family: ModelFamily, model?: string | null): number\n- `getAccounts`: getAccounts(): ManagedAccount[]\n- `saveToDisk`: async saveToDisk(): Promise<void>\n- `requestSaveToDisk`: requestSaveToDisk(): void\n- `flushSaveToDisk`: async flushSaveToDisk(): Promise<void>\n- `executeSave`: private async executeSave(): Promise<void>\n\n\n**Properties:**\n- `accounts`: ManagedAccount[]\n- `cursor`: any\n- `currentAccountIndexByFamily`: Record<ModelFamily, number>\n- `sessionOffsetApplied`: Record<ModelFamily, boolean>\n- `lastToastAccountIndex`: any\n- `lastToastTime`: any\n- `savePending`: any\n- `saveTimeout`: ReturnType<typeof setTimeout> | null\n- `savePromiseResolvers`: Array<() => void>\n\n\n\n## Interfaces\n\n### RateLimitBackoffResult\n```typescript\nexport interface RateLimitBackoffResult\n```\nNo documentation found\n\n\n### ManagedAccount\n```typescript\nexport interface ManagedAccount\n```\nNo documentation found\n\n\n## Types\n\n### RateLimitReason\n```typescript\nexport type RateLimitReason\n```\nNo documentation found\n\n\n### BaseQuotaKey\n```typescript\nexport type BaseQuotaKey\n```\nNo documentation found\n\n\n### QuotaKey\n```typescript\nexport type QuotaKey\n```\nNo documentation found\n",
  "metadata": {
    "created_at": "2026-01-30T05:26:51.914Z",
    "updated_at": "2026-01-30T05:26:51.914Z",
    "hash": "77fa37fdf89b052918011b0a93e6c50d76252a0c7f215be1bbf2841762d23284",
    "dependencies": [
      "./auth",
      "./storage",
      "./types",
      "./config/schema",
      "./rotation"
    ],
    "symbols": [
      "RateLimitReason",
      "RateLimitBackoffResult",
      "QUOTA_EXHAUSTED_BACKOFFS",
      "RATE_LIMIT_EXCEEDED_BACKOFF",
      "MODEL_CAPACITY_EXHAUSTED_BACKOFF",
      "SERVER_ERROR_BACKOFF",
      "UNKNOWN_BACKOFF",
      "MIN_BACKOFF_MS",
      "parseRateLimitReason",
      "lower",
      "calculateBackoffMs",
      "index",
      "BaseQuotaKey",
      "QuotaKey",
      "ManagedAccount",
      "nowMs",
      "clampNonNegativeInt",
      "getQuotaKey",
      "base",
      "isRateLimitedForQuotaKey",
      "resetTime",
      "isRateLimitedForFamily",
      "antigravityIsLimited",
      "cliIsLimited",
      "isRateLimitedForHeaderStyle",
      "modelKey",
      "baseKey",
      "clearExpiredRateLimits",
      "now",
      "keys",
      "key",
      "resetTime",
      "AccountManager",
      "stored",
      "authParts",
      "baseNow",
      "matchesFallback",
      "defaultIndex",
      "authParts",
      "hasMatching",
      "now",
      "newAccount",
      "parts",
      "now",
      "currentIndex",
      "now",
      "quotaKey",
      "next",
      "healthTracker",
      "tokenTracker",
      "accountsWithMetrics",
      "selectedIndex",
      "selected",
      "pidOffset",
      "baseIndex",
      "current",
      "isLimitedForRequestedStyle",
      "next",
      "available",
      "account",
      "key",
      "failures",
      "backoffMs",
      "key",
      "account",
      "antigravityKey",
      "cliKey",
      "minWaitMs",
      "touchedAt",
      "resetTime",
      "idx",
      "family",
      "parts",
      "available",
      "waitTimes",
      "a",
      "t",
      "antigravityKey",
      "cliKey",
      "t1",
      "t2",
      "accountWait",
      "claudeIndex",
      "geminiIndex",
      "storage",
      "resolvers",
      "resolve"
    ],
    "complexity_score": 100
  }
}