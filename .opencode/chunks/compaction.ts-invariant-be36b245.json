{
  "id": "compaction.ts-invariant-be36b245",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-supermemory/src/services/compaction.ts",
  "chunk_type": "invariant",
  "content": "# Invariants: compaction.ts\n\n## Core Invariants\n\n\n## Constraints\n- **MESSAGE_STORAGE**: join(homedir(), \".opencode\", \"messages\")\n- **PART_STORAGE**: join(homedir(), \".opencode\", \"parts\")\n- **DEFAULT_THRESHOLD**: 0.80\n- **MIN_TOKENS_FOR_COMPACTION**: 50_000\n- **COMPACTION_COOLDOWN_MS**: 30_000\n- **DEFAULT_CONTEXT_LIMIT**: 200_000\n\n## Assumptions\n\n\n## State Management\nNo explicit state management patterns detected\n\n## Error Handling\nError handling metrics: 9 try-catch blocks, 0 throw statements\n\n## Performance Considerations\nNo obvious performance optimization patterns detected\n\n## Security Considerations\nNo obvious security risks detected via static analysis",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.369Z",
    "updated_at": "2026-01-30T05:26:52.369Z",
    "hash": "6c583f792eb0ac49f700b9a518df95a5fe65d9c0263ac9e6404a6e35e37d5fcc",
    "dependencies": [
      "node:fs",
      "node:path",
      "node:os",
      "./client.js",
      "./logger.js",
      "../config.js"
    ],
    "symbols": [
      "MESSAGE_STORAGE",
      "PART_STORAGE",
      "DEFAULT_THRESHOLD",
      "MIN_TOKENS_FOR_COMPACTION",
      "COMPACTION_COOLDOWN_MS",
      "DEFAULT_CONTEXT_LIMIT",
      "CompactionState",
      "TokenInfo",
      "MessageInfo",
      "StoredMessage",
      "SummarizeContext",
      "CompactionOptions",
      "createCompactionPrompt",
      "memoriesSection",
      "getMessageDir",
      "directPath",
      "dir",
      "sessionPath",
      "getOrCreateMessageDir",
      "directPath",
      "dir",
      "sessionPath",
      "findNearestMessageWithFields",
      "files",
      "file",
      "content",
      "msg",
      "generateMessageId",
      "timestamp",
      "random",
      "generatePartId",
      "timestamp",
      "random",
      "injectHookMessage",
      "messageDir",
      "fallback",
      "now",
      "messageID",
      "partID",
      "resolvedAgent",
      "resolvedModel",
      "messageMeta",
      "textPart",
      "partDir",
      "err",
      "CompactionContext",
      "createCompactionHook",
      "state",
      "threshold",
      "getModelLimit",
      "fetchProjectMemoriesForCompaction",
      "result",
      "memories",
      "err",
      "injectCompactionContext",
      "projectMemories",
      "prompt",
      "success",
      "saveSummaryAsMemory",
      "result",
      "err",
      "checkAndTriggerCompaction",
      "lastCompaction",
      "tokens",
      "modelID",
      "providerID",
      "agent",
      "messageDir",
      "storedMessage",
      "configLimit",
      "contextLimit",
      "totalUsed",
      "usageRatio",
      "messageDir",
      "storedMessage",
      "err",
      "handleSummaryMessage",
      "resp",
      "messages",
      "summaryMessage",
      "textParts",
      "summaryContent",
      "err",
      "props",
      "sessionInfo",
      "info",
      "sessionID",
      "sessionID",
      "resp",
      "messages",
      "assistants",
      "lastAssistant",
      "messageDir",
      "storedMessage"
    ],
    "complexity_score": 100
  }
}