{
  "id": "request-helpers.ts-summary-c9f62bde",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-antigravity-auth/src/plugin/request-helpers.ts",
  "chunk_type": "summary",
  "content": "# Summary: request-helpers.ts\n\n## File Type\n.ts - TypeScript source file\n\n## Purpose\nDocumented purpose found in JSDoc\n\n## Key Components\n\n### Functions (61)\n- **appendDescriptionHint**: Appends a hint to a schema's description field.\n- **convertRefsToHints**: Phase 1a: Converts $ref to description hints.\n$ref: \"#/$defs/Foo\" → { type: \"object\", description: \"See: Foo\" }\n- **convertConstToEnum**: Phase 1b: Converts const to enum.\n{ const: \"foo\" } → { enum: [\"foo\"] }\n- **addEnumHints**: Phase 1c: Adds enum hints to description.\n{ enum: [\"a\", \"b\", \"c\"] } → adds \"(Allowed: a, b, c)\" to description\n- **addAdditionalPropertiesHints**: Phase 1d: Adds additionalProperties hints.\n{ additionalProperties: false } → adds \"(No extra properties allowed)\" to description\n- **moveConstraintsToDescription**: Phase 1e: Moves unsupported constraints to description hints.\n{ minLength: 1, maxLength: 100 } → adds \"(minLength: 1) (maxLength: 100)\" to description\n- **mergeAllOf**: Phase 2a: Merges allOf schemas into a single object.\n{ allOf: [{ properties: { a: ... } }, { properties: { b: ... } }] }\n→ { properties: { a: ..., b: ... } }\n- **scoreSchemaOption**: Scores a schema option for selection in anyOf/oneOf flattening.\nHigher score = more preferred.\n- **tryMergeEnumFromUnion**: Checks if an anyOf/oneOf array represents enum choices.\nReturns the merged enum values if so, otherwise null.\n\nHandles patterns like:\n- anyOf: [{ const: \"a\" }, { const: \"b\" }]\n- anyOf: [{ enum: [\"a\"] }, { enum: [\"b\"] }]\n- anyOf: [{ type: \"string\", const: \"a\" }, { type: \"string\", const: \"b\" }]\n- **flattenAnyOfOneOf**: Phase 2b: Flattens anyOf/oneOf to the best option with type hints.\n{ anyOf: [{ type: \"string\" }, { type: \"number\" }] }\n→ { type: \"string\", description: \"(Accepts: string | number)\" }\n\nSpecial handling for enum patterns:\n{ anyOf: [{ const: \"a\" }, { const: \"b\" }] }\n→ { type: \"string\", enum: [\"a\", \"b\"] }\n- **flattenTypeArrays**: Phase 2c: Flattens type arrays to single type with nullable hint.\n{ type: [\"string\", \"null\"] } → { type: \"string\", description: \"(nullable)\" }\n- **removeUnsupportedKeywords**: Phase 3: Removes unsupported keywords after hints have been extracted.\n- **cleanupRequiredFields**: Phase 3b: Cleans up required fields - removes entries that don't exist in properties.\n- **addEmptySchemaPlaceholder**: Phase 4: Adds placeholder property for empty object schemas.\nClaude VALIDATED mode requires at least one property.\n- **cleanJSONSchemaForAntigravity**: Cleans a JSON schema for Antigravity API compatibility.\nTransforms unsupported features into description hints while preserving semantic information.\n\nPorted from CLIProxyAPI's CleanJSONSchemaForAntigravity (gemini_schema.go)\n- **isThinkingCapableModel**: Checks if a model name indicates thinking/reasoning capability.\nModels with \"thinking\", \"gemini-3\", or \"opus\" in their name support extended thinking.\n- **extractThinkingConfig**: Extracts thinking configuration from various possible request locations.\nSupports both Gemini-style thinkingConfig and Anthropic-style thinking options.\n- **extractVariantThinkingConfig**: Extracts variant thinking config from OpenCode's providerOptions.\n\nAll Antigravity models route through the Google provider, so we only check\nproviderOptions.google. Supports two formats:\n\n1. Gemini 3 native: { google: { thinkingLevel: \"high\", includeThoughts: true } }\n2. Budget-based (Claude/Gemini 2.5): { google: { thinkingConfig: { thinkingBudget: 32000 } } }\n- **resolveThinkingConfig**: Determines the final thinking configuration based on model capabilities and user settings.\nFor Claude thinking models, we keep thinking enabled even in multi-turn conversations.\nThe filterUnsignedThinkingBlocks function will handle signature validation/restoration.\n- **isThinkingPart**: Checks if a part is a thinking/reasoning block (Anthropic or Gemini style).\n- **hasSignatureField**: Checks if a part has a signature field (thinking block signature).\nUsed to detect foreign thinking blocks that might have unknown type values.\n- **isToolBlock**: Checks if a part is a tool block (tool_use or tool_result).\nTool blocks must never be filtered - they're required for tool call/result pairing.\nHandles multiple formats:\n- Anthropic: { type: \"tool_use\" }, { type: \"tool_result\", tool_use_id }\n- Nested: { tool_result: { tool_use_id } }, { tool_use: { id } }\n- Gemini: { functionCall }, { functionResponse }\n- **stripAllThinkingBlocks**: Unconditionally strips ALL thinking/reasoning blocks from a content array.\nUsed for Claude models to avoid signature validation errors entirely.\nClaude will generate fresh thinking for each turn.\n- **removeTrailingThinkingBlocks**: Removes trailing thinking blocks from a content array.\nClaude API requires that assistant messages don't end with thinking blocks.\nOnly removes unsigned thinking blocks; preserves those with valid signatures.\n- **hasValidSignature**: Checks if a thinking part has a valid signature.\nA valid signature is a non-empty string with at least 50 characters.\n- **getSignature**: Gets the signature from a thinking part, if present.\n- **isOurCachedSignature**: Checks if a thinking part's signature was generated by our plugin (exists in our cache).\nThis prevents accepting signatures from other providers (e.g., direct Anthropic API, OpenAI)\nwhich would cause \"Invalid signature\" errors when sent to Antigravity Claude.\n- **getThinkingText**: Gets the text content from a thinking part.\n- **stripCacheControlRecursively**: Recursively strips cache_control and providerOptions from any object.\nThese fields can be injected by SDKs, but Claude rejects them inside thinking blocks.\n- **sanitizeThinkingPart**: Sanitizes a thinking part by keeping only the allowed fields.\nIn particular, ensures `thinking` is a string (not an object with cache_control).\nReturns null if the thinking block has no valid content.\n- **findLastAssistantIndex**: No documentation found\n- **filterContentArray**: No documentation found\n- **filterUnsignedThinkingBlocks**: Filters thinking blocks from contents unless the signature matches our cache.\nAttempts to restore signatures from cache for thinking blocks that lack signatures.\n- **filterMessagesThinkingBlocks**: Filters thinking blocks from Anthropic-style messages[] payloads using cached signatures.\n- **deepFilterThinkingBlocks**: No documentation found\n- **transformGeminiCandidate**: Transforms Gemini-style thought parts (thought: true) and Anthropic-style\nthinking parts (type: \"thinking\") to reasoning format.\nClaude responses through Antigravity may use candidates structure with Anthropic-style parts.\n- **transformThinkingParts**: Transforms thinking/reasoning content in response parts to OpenCode's expected format.\nHandles both Gemini-style (thought: true) and Anthropic-style (type: \"thinking\") formats.\nAlso extracts reasoning_content for Anthropic-style responses.\n- **normalizeThinkingConfig**: Ensures thinkingConfig is valid: includeThoughts only allowed when budget > 0.\n- **parseAntigravityApiBody**: Parses an Antigravity API body; handles array-wrapped responses the API sometimes returns.\n- **extractUsageMetadata**: Extracts usageMetadata from a response object, guarding types.\n- **extractUsageFromSsePayload**: Walks SSE lines to find a usage-bearing response chunk.\n- **rewriteAntigravityPreviewAccessError**: Enhances 404 errors for Antigravity models with a direct preview-access message.\n- **needsPreviewAccessOverride**: No documentation found\n- **isAntigravityModel**: No documentation found\n- **isEmptyResponseBody**: Checks if a JSON response body represents an empty response.\n\nEmpty responses occur when:\n- No candidates in Gemini format\n- No choices in OpenAI format\n- Candidates/choices exist but have no content\n- **createStreamingChunkCounter**: No documentation found\n- **isMeaningfulSseLine**: Checks if an SSE line contains meaningful content.\n- **recursivelyParseJsonStrings**: No documentation found\n- **fixToolResponseGrouping**: Groups function calls with their responses, handling ID mismatches.\n\nThis is a port of LLM-API-Key-Proxy's _fix_tool_response_grouping() function.\n\nWhen context compaction or other processes strip tool responses, the tool call\nIDs become orphaned. This function attempts to recover by:\n\n1. Pass 1: Match by exact ID (normal case)\n2. Pass 2: Match by function name (for ID mismatches)\n3. Pass 3: Match \"unknown_function\" orphans or take first available\n4. Fallback: Create placeholder responses for missing tool results\n- **detectToolIdMismatches**: Checks if contents have any tool call/response ID mismatches.\n- **findOrphanedToolUseIds**: Find orphaned tool_use IDs (tool_use without matching tool_result).\nWorks on Claude format messages.\n- **fixClaudeToolPairing**: Fix orphaned tool_use blocks in Claude format messages.\nMirrors fixToolResponseGrouping() but for Claude's messages[] format.\n\nClaude format:\n- assistant message with content[]: { type: 'tool_use', id, name, input }\n- user message with content[]: { type: 'tool_result', tool_use_id, content }\n- **removeOrphanedToolUse**: Nuclear option: Remove orphaned tool_use blocks entirely.\nCalled when fixClaudeToolPairing() fails to pair all tools.\n- **validateAndFixClaudeToolPairing**: Validate and fix tool pairing with fallback nuclear option.\nDefense in depth: tries gentle fix first, then nuclear removal.\n- **formatTypeHint**: Formats a type hint for a property schema.\nPort of LLM-API-Key-Proxy's _format_type_hint()\n- **injectParameterSignatures**: Injects parameter signatures into tool descriptions.\nPort of LLM-API-Key-Proxy's _inject_signature_into_descriptions()\n\nThis helps prevent tool hallucination by explicitly listing parameters\nin the description, making it harder for the model to hallucinate\nparameters from its training data.\n- **injectToolHardeningInstruction**: Injects a tool hardening system instruction into the request payload.\nPort of LLM-API-Key-Proxy's _inject_tool_hardening_instruction()\n- **assignToolIdsToContents**: Assigns IDs to functionCall parts and returns the pending call IDs by name.\nThis is the first pass of tool ID assignment.\n- **matchResponseIdsToContents**: Matches functionResponse IDs to their corresponding functionCall IDs.\nThis is the second pass of tool ID assignment.\n- **applyToolPairingFixes**: Applies all tool fixes to a request payload for Claude models.\nThis includes:\n1. Tool ID assignment for functionCalls\n2. Response ID matching for functionResponses\n3. Orphan recovery via fixToolResponseGrouping\n4. Claude format pairing fix via validateAndFixClaudeToolPairing\n- **createSyntheticErrorResponse**: Creates a synthetic Claude SSE streaming response with error content.\n\nWhen returning HTTP 400/500 errors to OpenCode, the session becomes locked\nand the user cannot use /compact or other commands. This function creates\na fake \"successful\" SSE response (200 OK) with the error message as text content,\nallowing the user to continue using the session.\n\n\n\n\n## Dependencies\n- ./config\n- ./logger\n- ../constants\n- ./image-saver\n- ./transform/types\n\n## Exports\n- cleanJSONSchemaForAntigravity\n- AntigravityApiError\n- AntigravityApiBody\n- AntigravityUsageMetadata\n- ThinkingConfig\n- DEFAULT_THINKING_BUDGET\n- isThinkingCapableModel\n- extractThinkingConfig\n- VariantThinkingConfig\n- extractVariantThinkingConfig\n- resolveThinkingConfig\n- filterUnsignedThinkingBlocks\n- filterMessagesThinkingBlocks\n- deepFilterThinkingBlocks\n- transformThinkingParts\n- normalizeThinkingConfig\n- parseAntigravityApiBody\n- extractUsageMetadata\n- extractUsageFromSsePayload\n- rewriteAntigravityPreviewAccessError\n- isEmptyResponseBody\n- StreamingChunkCounter\n- createStreamingChunkCounter\n- isMeaningfulSseLine\n- recursivelyParseJsonStrings\n- fixToolResponseGrouping\n- detectToolIdMismatches\n- findOrphanedToolUseIds\n- fixClaudeToolPairing\n- validateAndFixClaudeToolPairing\n- injectParameterSignatures\n- injectToolHardeningInstruction\n- assignToolIdsToContents\n- matchResponseIdsToContents\n- applyToolPairingFixes\n- createSyntheticErrorResponse\n\n## Complexity Metrics\n- Lines of code: 2774\n- Estimated complexity: 100/100\n\n## Notes\nNo specific notes found",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.009Z",
    "updated_at": "2026-01-30T05:26:52.009Z",
    "hash": "6168b50a552f367f2c3555ca73352bddaee13c8cb37387a2143b3cbf3cb15fbb",
    "dependencies": [
      "./config",
      "./logger",
      "../constants",
      "./image-saver",
      "./transform/types"
    ],
    "symbols": [
      "log",
      "ANTIGRAVITY_PREVIEW_LINK",
      "UNSUPPORTED_CONSTRAINTS",
      "UNSUPPORTED_KEYWORDS",
      "appendDescriptionHint",
      "existing",
      "newDescription",
      "convertRefsToHints",
      "refVal",
      "defName",
      "hint",
      "existingDesc",
      "newDescription",
      "result",
      "convertConstToEnum",
      "result",
      "addEnumHints",
      "result",
      "vals",
      "addAdditionalPropertiesHints",
      "result",
      "moveConstraintsToDescription",
      "result",
      "constraint",
      "mergeAllOf",
      "result",
      "merged",
      "mergedRequired",
      "item",
      "req",
      "existingRequired",
      "scoreSchemaOption",
      "type",
      "tryMergeEnumFromUnion",
      "enumValues",
      "option",
      "val",
      "flattenAnyOfOneOf",
      "result",
      "unionKey",
      "options",
      "parentDesc",
      "mergedEnum",
      "bestIdx",
      "bestScore",
      "allTypes",
      "i",
      "selected",
      "childDesc",
      "uniqueTypes",
      "hint",
      "flattenTypeArrays",
      "result",
      "localNullableFields",
      "types",
      "hasNull",
      "nonNullTypes",
      "firstType",
      "newProps",
      "propPath",
      "processed",
      "objectPath",
      "existing",
      "nullableAtRoot",
      "removeUnsupportedKeywords",
      "result",
      "propertiesResult",
      "cleanupRequiredFields",
      "result",
      "validRequired",
      "addEmptySchemaPlaceholder",
      "result",
      "isObjectType",
      "hasProperties",
      "cleanJSONSchemaForAntigravity",
      "result",
      "AntigravityApiError",
      "AntigravityApiBody",
      "AntigravityUsageMetadata",
      "ThinkingConfig",
      "DEFAULT_THINKING_BUDGET",
      "isThinkingCapableModel",
      "lowerModel",
      "extractThinkingConfig",
      "thinkingConfig",
      "config",
      "anthropicThinking",
      "thinking",
      "VariantThinkingConfig",
      "extractVariantThinkingConfig",
      "google",
      "result",
      "tc",
      "search",
      "resolveThinkingConfig",
      "isThinkingPart",
      "hasSignatureField",
      "isToolBlock",
      "stripAllThinkingBlocks",
      "removeTrailingThinkingBlocks",
      "result",
      "part",
      "isValid",
      "hasValidSignature",
      "signature",
      "getSignature",
      "signature",
      "isOurCachedSignature",
      "text",
      "partSignature",
      "cachedSignature",
      "getThinkingText",
      "maybeText",
      "maybeText",
      "stripCacheControlRecursively",
      "result",
      "sanitizeThinkingPart",
      "textContent",
      "maybeText",
      "hasContent",
      "sanitized",
      "thinkingContent",
      "maybeText",
      "hasContent",
      "sanitized",
      "textContent",
      "maybeText",
      "hasContent",
      "sanitized",
      "findLastAssistantIndex",
      "i",
      "content",
      "filterContentArray",
      "filtered",
      "item",
      "isThinking",
      "hasSignature",
      "existingSignature",
      "hasValidSignature",
      "thinkingText",
      "sentinelPart",
      "sanitized",
      "text",
      "cachedSignature",
      "restoredPart",
      "sanitized",
      "filterUnsignedThinkingBlocks",
      "lastAssistantIdx",
      "isLastAssistant",
      "filteredParts",
      "trimmedParts",
      "isAssistantRole",
      "isLastAssistantContent",
      "filteredContent",
      "trimmedContent",
      "filterMessagesThinkingBlocks",
      "lastAssistantIdx",
      "isAssistantRole",
      "isLastAssistant",
      "filteredContent",
      "trimmedContent",
      "deepFilterThinkingBlocks",
      "visited",
      "walk",
      "obj",
      "transformGeminiCandidate",
      "content",
      "thinkingTexts",
      "transformedParts",
      "transformed",
      "thinkingText",
      "transformed",
      "parsedArgs",
      "result",
      "transformThinkingParts",
      "resp",
      "result",
      "reasoningTexts",
      "transformedContent",
      "block",
      "thinkingText",
      "normalizeThinkingConfig",
      "record",
      "budgetRaw",
      "includeRaw",
      "thinkingBudget",
      "includeThoughts",
      "enableThinking",
      "finalInclude",
      "normalized",
      "parseAntigravityApiBody",
      "parsed",
      "firstObject",
      "extractUsageMetadata",
      "usage",
      "asRecord",
      "toNumber",
      "extractUsageFromSsePayload",
      "lines",
      "line",
      "jsonText",
      "parsed",
      "usage",
      "rewriteAntigravityPreviewAccessError",
      "error",
      "trimmedMessage",
      "messagePrefix",
      "enhancedMessage",
      "needsPreviewAccessOverride",
      "errorMessage",
      "isAntigravityModel",
      "isEmptyResponseBody",
      "parsed",
      "firstCandidate",
      "content",
      "parts",
      "hasContent",
      "firstChoice",
      "message",
      "response",
      "StreamingChunkCounter",
      "createStreamingChunkCounter",
      "count",
      "hasRealContent",
      "isMeaningfulSseLine",
      "data",
      "parsed",
      "candidate",
      "parts",
      "part",
      "SKIP_PARSE_KEYS",
      "recursivelyParseJsonStrings",
      "result",
      "stripped",
      "hasControlCharEscapes",
      "hasIntentionalEscapes",
      "parsed",
      "lastBracket",
      "cleaned",
      "parsed",
      "lastBrace",
      "cleaned",
      "parsed",
      "fixToolResponseGrouping",
      "newContents",
      "pendingGroups",
      "collectedResponses",
      "content",
      "role",
      "parts",
      "responseParts",
      "resp",
      "respId",
      "i",
      "group",
      "groupResponses",
      "resp",
      "funcCalls",
      "callIds",
      "funcNames",
      "group",
      "groupResponses",
      "i",
      "expectedId",
      "expectedName",
      "matchedId",
      "orphanName",
      "orphanResp",
      "placeholder",
      "detectToolIdMismatches",
      "expectedIds",
      "foundIds",
      "content",
      "parts",
      "part",
      "expectedSet",
      "foundSet",
      "missingIds",
      "orphanIds",
      "findOrphanedToolUseIds",
      "toolUseIds",
      "toolResultIds",
      "msg",
      "block",
      "fixClaudeToolPairing",
      "toolUseMap",
      "i",
      "msg",
      "block",
      "toolResultIds",
      "msg",
      "block",
      "orphans",
      "orphansByMsgIndex",
      "orphan",
      "existing",
      "result",
      "i",
      "orphansForMsg",
      "nextMsg",
      "placeholders",
      "removeOrphanedToolUse",
      "validateAndFixClaudeToolPairing",
      "fixed",
      "orphanIds",
      "formatTypeHint",
      "type",
      "enumVals",
      "items",
      "itemType",
      "nestedProps",
      "nestedReq",
      "nestedList",
      "t",
      "req",
      "nestedProps",
      "nestedReq",
      "nestedList",
      "t",
      "req",
      "injectParameterSignatures",
      "declarations",
      "newDeclarations",
      "schema",
      "required",
      "properties",
      "paramList",
      "typeHint",
      "isRequired",
      "sigStr",
      "injectToolHardeningInstruction",
      "existing",
      "parts",
      "instructionPart",
      "parts",
      "assignToolIdsToContents",
      "toolCallCounter",
      "pendingCallIdsByName",
      "newContents",
      "newParts",
      "call",
      "nameKey",
      "queue",
      "matchResponseIdsToContents",
      "newParts",
      "resp",
      "queue",
      "applyToolPairingFixes",
      "contentsFixed",
      "messagesFixed",
      "contentsWithMatchedIds",
      "createSyntheticErrorResponse",
      "messageId",
      "events",
      "body"
    ],
    "complexity_score": 100
  }
}