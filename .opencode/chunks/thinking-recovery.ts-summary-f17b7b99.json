{
  "id": "thinking-recovery.ts-summary-f17b7b99",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-antigravity-auth/src/plugin/thinking-recovery.ts",
  "chunk_type": "summary",
  "content": "# Summary: thinking-recovery.ts\n\n## File Type\n.ts - TypeScript source file\n\n## Purpose\nDocumented purpose found in JSDoc\n\n## Key Components\n\n### Functions (13)\n- **isThinkingPart**: Checks if a message part is a thinking/reasoning block.\n- **isFunctionResponsePart**: Checks if a message part is a function response (tool result).\n- **isFunctionCallPart**: Checks if a message part is a function call.\n- **isToolResultMessage**: Checks if a message is a tool result container (user role with functionResponse).\n- **messageHasThinking**: Checks if a message contains thinking/reasoning content.\n- **messageHasToolCalls**: Checks if a message contains tool calls.\n- **analyzeConversationState**: Analyzes conversation state to detect tool use loops and thinking mode issues.\n\nKey insight: A \"turn\" can span multiple assistant messages in a tool-use loop.\nWe need to find the TURN START (first assistant message after last real user message)\nand check if THAT message had thinking, not just the last assistant message.\n- **stripAllThinkingBlocks**: Strips all thinking blocks from messages.\nUsed before injecting synthetic messages to avoid invalid thinking patterns.\n- **countTrailingToolResults**: Counts tool results at the end of the conversation.\n- **closeToolLoopForThinking**: Closes an incomplete tool loop by injecting synthetic messages to start a new turn.\n\nThis is the \"let it crash and start again\" recovery mechanism.\n\nWhen we detect:\n- We're in a tool loop (conversation ends with functionResponse)\n- The tool call was made WITHOUT thinking (thinking was stripped/corrupted)\n- We NOW want to enable thinking\n\nInstead of trying to fix the corrupted state, we:\n1. Strip ALL thinking blocks (removes any corrupted ones)\n2. Add synthetic MODEL message to complete the non-thinking turn\n3. Add synthetic USER message to start a NEW turn\n\nThis allows Claude to generate fresh thinking for the new turn.\n- **needsThinkingRecovery**: Checks if conversation state requires tool loop closure for thinking recovery.\n\nReturns true if:\n- We're in a tool loop (state.inToolLoop)\n- The turn didn't start with thinking (state.turnHasThinking === false)\n\nThis is the trigger for the \"let it crash and start again\" recovery.\n- **looksLikeCompactedThinkingTurn**: Detects if a message looks like it was compacted from a thinking-enabled turn.\n\nThis is a heuristic to distinguish between:\n- \"Never had thinking\" (model didn't use thinking mode)\n- \"Thinking was stripped\" (context compaction removed thinking blocks)\n\nPort of LLM-API-Key-Proxy's _looks_like_compacted_thinking_turn()\n\nHeuristics:\n1. Has functionCall parts (typical thinking flow produces tool calls)\n2. No thinking parts (thought: true)\n3. No text content before functionCall (thinking responses usually have text)\n- **hasPossibleCompactedThinking**: Checks if any message in the current turn looks like it was compacted.\n\n\n\n\n## Dependencies\nNo external dependencies\n\n## Exports\n- ConversationState\n- analyzeConversationState\n- closeToolLoopForThinking\n- needsThinkingRecovery\n- looksLikeCompactedThinkingTurn\n- hasPossibleCompactedThinking\n\n## Complexity Metrics\n- Lines of code: 396\n- Estimated complexity: 100/100\n\n## Notes\nNo specific notes found",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.066Z",
    "updated_at": "2026-01-30T05:26:52.066Z",
    "hash": "83a54aa28e222d5452e43d4d909f5617522e1980d3f0873cf2ee03ad17418547",
    "dependencies": [],
    "symbols": [
      "ConversationState",
      "isThinkingPart",
      "isFunctionResponsePart",
      "isFunctionCallPart",
      "isToolResultMessage",
      "parts",
      "messageHasThinking",
      "messageHasToolCalls",
      "analyzeConversationState",
      "state",
      "lastRealUserIdx",
      "i",
      "msg",
      "i",
      "msg",
      "role",
      "hasThinking",
      "hasToolCalls",
      "lastMsg",
      "stripAllThinkingBlocks",
      "filteredParts",
      "filteredContent",
      "countTrailingToolResults",
      "count",
      "i",
      "msg",
      "parts",
      "functionResponses",
      "closeToolLoopForThinking",
      "strippedContents",
      "toolResultCount",
      "syntheticModelContent",
      "syntheticModel",
      "syntheticUser",
      "needsThinkingRecovery",
      "looksLikeCompactedThinkingTurn",
      "parts",
      "hasFunctionCall",
      "hasThinking",
      "hasTextBeforeFunctionCall",
      "firstFuncIdx",
      "hasPossibleCompactedThinking",
      "i",
      "msg"
    ],
    "complexity_score": 100
  }
}