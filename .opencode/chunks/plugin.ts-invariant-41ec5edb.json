{
  "id": "plugin.ts-invariant-41ec5edb",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-antigravity-auth/src/plugin.ts",
  "chunk_type": "invariant",
  "content": "# Invariants: plugin.ts\n\n## Core Invariants\n\n\n## Constraints\n- **MAX_OAUTH_ACCOUNTS**: 10\n- **MAX_WARMUP_SESSIONS**: 1000\n- **MAX_WARMUP_RETRIES**: 2\n- **CAPACITY_BACKOFF_TIERS_MS**: [5000, 10000, 20000, 30000, 60000]\n- **FIRST_RETRY_DELAY_MS**: 1000\n- **SWITCH_ACCOUNT_DELAY_MS**: 5000\n- **RATE_LIMIT_DEDUP_WINDOW_MS**: 2000\n- **RATE_LIMIT_STATE_RESET_MS**: 120_000\n- **MAX_CONSECUTIVE_FAILURES**: 5\n- **FAILURE_COOLDOWN_MS**: 30_000\n- **FAILURE_STATE_RESET_MS**: 120_000\n- **SOFT_TIMEOUT_MS**: 30000\n- **CALLBACK_TIMEOUT_MS**: 30000\n\n## Assumptions\n\n\n## State Management\nNo explicit state management patterns detected\n\n## Error Handling\nError handling metrics: 38 try-catch blocks, 4 throw statements\n\n## Performance Considerations\nPerformance patterns: Contains explicit loops\n\n## Security Considerations\nNo obvious security risks detected via static analysis",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.130Z",
    "updated_at": "2026-01-30T05:26:52.130Z",
    "hash": "239b252c7ea5ab00acdd9bd350ca9f8872d8a3ba1449fb812cb801189c5865f8",
    "dependencies": [
      "node:child_process",
      "./constants",
      "./antigravity/oauth",
      "./antigravity/oauth",
      "./plugin/auth",
      "./plugin/cli",
      "./plugin/project",
      "./plugin/debug",
      "./plugin/request",
      "./plugin/transform/model-resolver",
      "./plugin/request-helpers",
      "./plugin/errors",
      "./plugin/token",
      "./plugin/server",
      "./plugin/storage",
      "./plugin/accounts",
      "./hooks/auto-update-checker",
      "./plugin/config",
      "./plugin/recovery",
      "./plugin/cache",
      "./plugin/refresh-queue",
      "./plugin/logger",
      "./plugin/rotation",
      "./plugin/types"
    ],
    "symbols": [
      "MAX_OAUTH_ACCOUNTS",
      "MAX_WARMUP_SESSIONS",
      "MAX_WARMUP_RETRIES",
      "CAPACITY_BACKOFF_TIERS_MS",
      "getCapacityBackoffDelay",
      "index",
      "warmupAttemptedSessionIds",
      "warmupSucceededSessionIds",
      "log",
      "trackWarmupAttempt",
      "first",
      "attempts",
      "getWarmupAttemptCount",
      "markWarmupSuccess",
      "first",
      "clearWarmupAttempt",
      "isWSL",
      "release",
      "isWSL2",
      "version",
      "isRemoteEnvironment",
      "shouldSkipLocalServer",
      "openBrowser",
      "promptOAuthCallbackValue",
      "rl",
      "OAuthCallbackParams",
      "getStateFromAuthorizationUrl",
      "extractOAuthCallbackParams",
      "code",
      "state",
      "parseOAuthCallbackInput",
      "trimmed",
      "url",
      "code",
      "state",
      "promptManualOAuthInput",
      "callbackInput",
      "params",
      "clampInt",
      "persistAccountPool",
      "now",
      "stored",
      "accounts",
      "indexByRefreshToken",
      "indexByEmail",
      "i",
      "acc",
      "result",
      "parts",
      "existingByEmail",
      "existingByToken",
      "existingIndex",
      "newIndex",
      "existing",
      "oldToken",
      "activeIndex",
      "retryAfterMsFromResponse",
      "retryAfterMsHeader",
      "parsed",
      "retryAfterHeader",
      "parsed",
      "parseDurationToMs",
      "match",
      "value",
      "unit",
      "RateLimitBodyInfo",
      "extractRateLimitBodyInfo",
      "error",
      "message",
      "details",
      "reason",
      "detail",
      "type",
      "detailReason",
      "detail",
      "type",
      "retryDelay",
      "retryDelayMs",
      "detail",
      "metadata",
      "quotaResetDelay",
      "quotaResetTime",
      "quotaResetDelayMs",
      "afterMatch",
      "rawDuration",
      "parsed",
      "extractRetryInfoFromBody",
      "text",
      "parsed",
      "formatWaitTime",
      "seconds",
      "minutes",
      "remainingSeconds",
      "hours",
      "remainingMinutes",
      "FIRST_RETRY_DELAY_MS",
      "SWITCH_ACCOUNT_DELAY_MS",
      "RATE_LIMIT_DEDUP_WINDOW_MS",
      "RATE_LIMIT_STATE_RESET_MS",
      "RateLimitState",
      "rateLimitStateByAccountQuota",
      "emptyResponseAttempts",
      "getRateLimitBackoff",
      "now",
      "stateKey",
      "previous",
      "baseDelay",
      "backoffDelay",
      "attempt",
      "baseDelay",
      "backoffDelay",
      "resetRateLimitState",
      "stateKey",
      "resetAllRateLimitStateForAccount",
      "key",
      "headerStyleToQuotaKey",
      "accountFailureState",
      "MAX_CONSECUTIVE_FAILURES",
      "FAILURE_COOLDOWN_MS",
      "FAILURE_STATE_RESET_MS",
      "trackAccountFailure",
      "now",
      "previous",
      "failures",
      "shouldCooldown",
      "cooldownMs",
      "resetAccountFailureState",
      "sleep",
      "timeout",
      "onAbort",
      "cleanup",
      "createAntigravityPlugin",
      "config",
      "sessionRecovery",
      "updateChecker",
      "eventHandler",
      "props",
      "sessionID",
      "messageID",
      "error",
      "messageInfo",
      "recovered",
      "successToast",
      "auth",
      "authParts",
      "storedAccounts",
      "accountManager",
      "refreshQueue",
      "logPath",
      "model",
      "latestAuth",
      "urlString",
      "family",
      "model",
      "debugLines",
      "pushDebug",
      "FailureContext",
      "lastFailure",
      "lastError",
      "abortSignal",
      "checkAborted",
      "showToast",
      "quietMode",
      "hasOtherAccountWithAntigravity",
      "otherAccounts",
      "accountCount",
      "account",
      "waitMs",
      "waitSecValue",
      "maxWaitMs",
      "waitTimeFormatted",
      "accountLabel",
      "authRecord",
      "refreshed",
      "error",
      "error",
      "removed",
      "persistError",
      "storeError",
      "accessToken",
      "projectContext",
      "error",
      "error",
      "runThinkingWarmup",
      "warmupBody",
      "warmupUrl",
      "warmupHeaders",
      "warmupInit",
      "warmupDebugContext",
      "warmupResponse",
      "transformed",
      "error",
      "shouldSwitchAccount",
      "headerStyle",
      "explicitQuota",
      "alternateStyle",
      "quotaName",
      "altQuotaName",
      "forceThinkingRecovery",
      "tokenConsumed",
      "i",
      "currentEndpoint",
      "prepared",
      "originalUrl",
      "resolvedUrl",
      "debugContext",
      "response",
      "headerRetryMs",
      "bodyInfo",
      "serverRetryMs",
      "quotaKey",
      "rateLimitReason",
      "smartBackoffMs",
      "effectiveDelayMs",
      "isCapacityExhausted",
      "capacityBackoffMs",
      "backoffFormatted",
      "failures",
      "accountLabel",
      "alternateStyle",
      "safeModelName",
      "quotaName",
      "quotaMsg",
      "expBackoffMs",
      "expBackoffFormatted",
      "quotaKey",
      "shouldRetryEndpoint",
      "cloned",
      "bodyText",
      "errorMessage",
      "maxAttempts",
      "retryDelayMs",
      "clonedForCheck",
      "bodyText",
      "emptyAttemptKey",
      "currentAttempts",
      "emptyAttemptKeyClean",
      "transformedResponse",
      "contextError",
      "error",
      "recoveryError",
      "originalError",
      "recoveryMessage",
      "isHeadless",
      "accounts",
      "noBrowser",
      "useManualMode",
      "startFresh",
      "existingStorage",
      "existingAccounts",
      "loginMode",
      "projectId",
      "result",
      "authorization",
      "fallbackState",
      "browserOpened",
      "listener",
      "SOFT_TIMEOUT_MS",
      "callbackPromise",
      "timeoutPromise",
      "callbackUrl",
      "err",
      "params",
      "error",
      "isFirstAccount",
      "currentAccountCount",
      "currentStorage",
      "addAnother",
      "primary",
      "actualAccountCount",
      "finalStorage",
      "projectId",
      "existingStorage",
      "existingCount",
      "useManualFlow",
      "listener",
      "authorization",
      "fallbackState",
      "browserOpened",
      "CALLBACK_TIMEOUT_MS",
      "callbackPromise",
      "timeoutPromise",
      "callbackUrl",
      "err",
      "params",
      "result",
      "newTotal",
      "toastMessage",
      "error",
      "params",
      "result",
      "newTotal",
      "toastMessage",
      "AntigravityCLIOAuthPlugin",
      "GoogleOAuthPlugin",
      "toUrlString",
      "candidate",
      "toWarmupStreamUrl",
      "urlString",
      "url",
      "extractModelFromUrl",
      "match",
      "extractModelFromUrlWithSuffix",
      "match",
      "getModelFamilyFromUrl",
      "model",
      "family",
      "getHeaderStyleFromUrl",
      "modelWithSuffix",
      "isExplicitQuotaFromUrl",
      "modelWithSuffix"
    ],
    "complexity_score": 100
  }
}