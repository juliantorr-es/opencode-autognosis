{
  "id": "terminal.ts-summary-9443adb6",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-worktree/src/plugin/worktree/terminal.ts",
  "chunk_type": "summary",
  "content": "# Summary: terminal.ts\n\n## File Type\n.ts - TypeScript source file\n\n## Purpose\nPurpose not explicitly documented\n\n## Key Components\n\n### Functions (13)\n- **withTempScript**: Execute a function with a temporary script file that is guaranteed to be cleaned up.\nUses try-finally pattern to ensure cleanup even on errors.\n- **wrapWithSelfCleanup**: Wrap a bash script with trap-based self-cleanup.\nThe script deletes itself on ANY exit (success, error, or signal).\nThis eliminates race conditions with detached processes.\n- **wrapBatchWithSelfCleanup**: Wrap a batch script with self-cleanup.\nUses goto trick to delete itself after execution.\n- **isInsideWSL**: Check if running inside WSL (Windows Subsystem for Linux).\nChecks environment variables and os.release() for Microsoft string.\n- **detectTerminalType**: Detect the best terminal type for the current platform.\nPriority: tmux > WSL > platform-specific\n- **openTmuxWindow**: Open a new tmux window with mutex protection.\nIncludes stabilization delay after spawning to prevent races.\n\nSECURITY NOTE: Branch names and paths are passed via array-based spawn\n(Bun.spawnSync with array arguments), NOT shell string interpolation.\nThis prevents command injection even if values contain special characters.\nThe tmux `-n` flag treats its argument as a literal window name string.\n- **detectCurrentMacTerminal**: Detect the current macOS terminal from environment variables.\nPrioritizes terminal-specific env vars over TERM_PROGRAM for reliability.\n- **openMacOSTerminal**: Open terminal on macOS (Terminal.app, iTerm, Ghostty, etc.)\nDetects current terminal and uses appropriate method.\n- **detectCurrentLinuxTerminal**: Detect the current Linux terminal from environment variables.\nReturns null if no terminal can be detected (use fallback chain).\n- **openLinuxTerminal**: Open terminal on Linux with desktop environment detection.\nPriority: current terminal > xdg-terminal-exec > x-terminal-emulator > modern > DE > xterm\n\nNOTE: All Linux terminal spawns are detached, so we write the script directly\ninstead of using withTempScript. The script self-deletes via trap.\n- **openWindowsTerminal**: Open terminal on Windows (Windows Terminal or cmd).\nTries Windows Terminal (wt.exe) first, falls back to cmd.exe.\n\nNOTE: All Windows terminal spawns are detached, so we write the script directly\ninstead of using withTempScript. The script self-deletes via goto trick.\n- **openWSLTerminal**: Open terminal in WSL via Windows Terminal interop.\nFalls back to bash in current terminal if wt.exe not available.\n\nNOTE: All WSL terminal spawns are detached, so we write the script directly\ninstead of using withTempScript. The script self-deletes via trap.\n- **openTerminal**: Open a terminal window on the current platform.\nAutomatically detects the best terminal type and method.\n\n\n\n\n## Dependencies\n- node:fs/promises\n- node:os\n- node:path\n- zod\n- ../kdco-primitives\n- ../kdco-primitives\n\n## Exports\n- withTempScript\n- TerminalType\n- TerminalResult\n- detectTerminalType\n- openTmuxWindow\n- openMacOSTerminal\n- openLinuxTerminal\n- openWindowsTerminal\n- openWSLTerminal\n- openTerminal\n\n## Complexity Metrics\n- Lines of code: 996\n- Estimated complexity: 100/100\n\n## Notes\nNo specific notes found",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.390Z",
    "updated_at": "2026-01-30T05:26:52.390Z",
    "hash": "e114639335429b65892781d8fb20e2248fb82461b8ec89f827d2626576f5d31c",
    "dependencies": [
      "node:fs/promises",
      "node:os",
      "node:path",
      "zod",
      "../kdco-primitives",
      "../kdco-primitives"
    ],
    "symbols": [
      "withTempScript",
      "scriptPath",
      "cleanupError",
      "wrapWithSelfCleanup",
      "wrapBatchWithSelfCleanup",
      "TerminalType",
      "TerminalResult",
      "tmuxMutex",
      "STABILIZATION_DELAY_MS",
      "wslEnvSchema",
      "linuxTerminalEnvSchema",
      "macTerminalEnvSchema",
      "LinuxTerminal",
      "MacTerminal",
      "isInsideWSL",
      "parsed",
      "detectTerminalType",
      "openTmuxWindow",
      "tmuxArgs",
      "scriptPath",
      "escapedCwd",
      "escapedCommand",
      "scriptContent",
      "createResult",
      "error",
      "detectCurrentMacTerminal",
      "env",
      "termProgram",
      "openMacOSTerminal",
      "escapedCwd",
      "escapedCommand",
      "scriptContent",
      "terminal",
      "detachedScriptPath",
      "proc",
      "error",
      "remoteResult",
      "result",
      "kittyProc",
      "alacrittyProc",
      "warpProc",
      "escapedPath",
      "appleScript",
      "result",
      "proc",
      "exitCode",
      "stderr",
      "error",
      "detectCurrentLinuxTerminal",
      "env",
      "termProgram",
      "openLinuxTerminal",
      "escapedCwd",
      "escapedCommand",
      "scriptContent",
      "scriptPath",
      "tryTerminal",
      "check",
      "proc",
      "currentTerminal",
      "result",
      "kittyRemote",
      "xdgResult",
      "xteResult",
      "modernTerminals",
      "result",
      "deTerminals",
      "result",
      "xtermResult",
      "error",
      "openWindowsTerminal",
      "escapedCwd",
      "escapedCommand",
      "scriptContent",
      "scriptPath",
      "wtCheck",
      "proc",
      "proc",
      "error",
      "error",
      "openWSLTerminal",
      "escapedCwd",
      "escapedCommand",
      "scriptContent",
      "scriptPath",
      "wtResult",
      "proc",
      "proc",
      "error",
      "error",
      "openTerminal",
      "terminalType"
    ],
    "complexity_score": 100
  }
}