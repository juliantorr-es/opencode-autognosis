{
  "id": "rotation.ts-api-285d1a87",
  "file_path": "/Users/user/opencode-autognosis/reference repos/opencode-antigravity-auth/src/plugin/rotation.ts",
  "chunk_type": "api",
  "content": "# API Surface: rotation.ts\n\n## Public Functions\n\n### addJitter\n```typescript\nexport function addJitter(baseMs: number, jitterFactor: number = 0.3): number\n```\nAdd random jitter to a delay value.\nHelps break predictable timing patterns.\n\n**Parameters:**\n- `baseMs`: number - \n- `jitterFactor`: number - \n\n**Returns:** number\n\n\n### randomDelay\n```typescript\nexport function randomDelay(minMs: number, maxMs: number): number\n```\nGenerate a random delay within a range.\n\n**Parameters:**\n- `minMs`: number - \n- `maxMs`: number - \n\n**Returns:** number\n\n\n### sortByLruWithHealth\n```typescript\nexport function sortByLruWithHealth(\n  accounts: AccountWithMetrics[],\n  minHealthScore: number = 50,\n): AccountWithMetrics[]\n```\nSort accounts by LRU (least recently used first) with health score tiebreaker.\n\nPriority:\n1. Filter out rate-limited and cooling-down accounts\n2. Filter out unhealthy accounts (score < minUsable)\n3. Sort by lastUsed ascending (oldest first = most rested)\n4. Tiebreaker: higher health score wins\n\n**Parameters:**\n- `accounts`: AccountWithMetrics[] - \n- `minHealthScore`: number - \n\n**Returns:** AccountWithMetrics[]\n\n\n### selectHybridAccount\n```typescript\nexport function selectHybridAccount(\n  accounts: AccountWithMetrics[],\n  tokenTracker: TokenBucketTracker,\n  minHealthScore: number = 50,\n): number | null\n```\nSelect account using hybrid strategy:\n1. Filter available accounts (not rate-limited, not cooling down, healthy, has tokens)\n2. Calculate priority score: health (2x) + tokens (5x) + freshness (0.1x)\n3. Sort by score descending\n4. Return the best candidate (deterministic - highest score)\n\n**Parameters:**\n- `accounts`: AccountWithMetrics[] - \n- `tokenTracker`: TokenBucketTracker - \n- `minHealthScore`: number - \n\n**Returns:** number | null\n\n\n### getTokenTracker\n```typescript\nexport function getTokenTracker(): TokenBucketTracker\n```\nNo documentation found\n\n**Returns:** TokenBucketTracker\n\n\n### initTokenTracker\n```typescript\nexport function initTokenTracker(config: Partial<TokenBucketConfig>): TokenBucketTracker\n```\nNo documentation found\n\n**Parameters:**\n- `config`: Partial<TokenBucketConfig> - \n\n**Returns:** TokenBucketTracker\n\n\n### getHealthTracker\n```typescript\nexport function getHealthTracker(): HealthScoreTracker\n```\nGet the global health score tracker instance.\nCreates one with default config if not initialized.\n\n**Returns:** HealthScoreTracker\n\n\n### initHealthTracker\n```typescript\nexport function initHealthTracker(config: Partial<HealthScoreConfig>): HealthScoreTracker\n```\nInitialize the global health tracker with custom config.\nCall this at plugin startup if custom config is needed.\n\n**Parameters:**\n- `config`: Partial<HealthScoreConfig> - \n\n**Returns:** HealthScoreTracker\n\n\n## Classes\n\n### HealthScoreTracker\n```typescript\nexport class HealthScoreTracker\n```\nTracks health scores for accounts.\nHigher score = healthier account = preferred for selection.\n\n**Methods:**\n- `getScore`: getScore(accountIndex: number): number\n- `recordSuccess`: recordSuccess(accountIndex: number): void\n- `recordRateLimit`: recordRateLimit(accountIndex: number): void\n- `recordFailure`: recordFailure(accountIndex: number): void\n- `isUsable`: isUsable(accountIndex: number): boolean\n- `getConsecutiveFailures`: getConsecutiveFailures(accountIndex: number): number\n- `reset`: reset(accountIndex: number): void\n- `getSnapshot`: getSnapshot(): Map<number,\n\n\n**Properties:**\n- `scores`: any\n- `config`: HealthScoreConfig\n\n\n\n### TokenBucketTracker\n```typescript\nexport class TokenBucketTracker\n```\nClient-side rate limiting using Token Bucket algorithm.\nHelps prevent hitting server 429s by tracking \"cost\" of requests.\n\n**Methods:**\n- `getTokens`: getTokens(accountIndex: number): number\n- `hasTokens`: hasTokens(accountIndex: number, cost: number = 1): boolean\n- `consume`: consume(accountIndex: number, cost: number = 1): boolean\n- `refund`: refund(accountIndex: number, amount: number = 1): void\n- `getMaxTokens`: getMaxTokens(): number\n\n\n**Properties:**\n- `buckets`: any\n- `config`: TokenBucketConfig\n\n\n\n## Interfaces\n\n### HealthScoreConfig\n```typescript\nexport interface HealthScoreConfig\n```\nAccount Rotation System\n\nImplements advanced account selection algorithms:\n- Health Score: Track account wellness based on success/failure\n- LRU Selection: Prefer accounts with longest rest periods\n- Jitter: Add random variance to break predictable patterns\n\nUsed by 'hybrid' strategy for improved ban prevention and load distribution.\n\n\n### HealthScoreState\n```typescript\ninterface HealthScoreState\n```\nNo documentation found\n\n\n### AccountWithMetrics\n```typescript\nexport interface AccountWithMetrics\n```\nNo documentation found\n\n\n### AccountWithTokens\n```typescript\ninterface AccountWithTokens extends AccountWithMetrics\n```\nNo documentation found\n\n\n### TokenBucketConfig\n```typescript\nexport interface TokenBucketConfig\n```\nNo documentation found\n\n\n### TokenBucketState\n```typescript\ninterface TokenBucketState\n```\nNo documentation found\n\n\n## Types\n",
  "metadata": {
    "created_at": "2026-01-30T05:26:52.051Z",
    "updated_at": "2026-01-30T05:26:52.051Z",
    "hash": "0fea8bbd6e22eda89b7d37d12c90fd755b1eae13e0fc47cac477f6db3d32953e",
    "dependencies": [],
    "symbols": [
      "HealthScoreConfig",
      "DEFAULT_HEALTH_SCORE_CONFIG",
      "HealthScoreState",
      "HealthScoreTracker",
      "state",
      "now",
      "hoursSinceUpdate",
      "recoveredPoints",
      "now",
      "current",
      "now",
      "state",
      "current",
      "now",
      "state",
      "current",
      "result",
      "addJitter",
      "jitterRange",
      "jitter",
      "randomDelay",
      "AccountWithMetrics",
      "sortByLruWithHealth",
      "lruDiff",
      "selectHybridAccount",
      "candidates",
      "maxTokens",
      "scored",
      "AccountWithTokens",
      "calculateHybridScore",
      "healthComponent",
      "tokenComponent",
      "secondsSinceUsed",
      "freshnessComponent",
      "TokenBucketConfig",
      "DEFAULT_TOKEN_BUCKET_CONFIG",
      "TokenBucketState",
      "TokenBucketTracker",
      "state",
      "now",
      "minutesSinceUpdate",
      "recoveredTokens",
      "current",
      "current",
      "globalTokenTracker",
      "getTokenTracker",
      "initTokenTracker",
      "globalHealthTracker",
      "getHealthTracker",
      "initHealthTracker"
    ],
    "complexity_score": 100
  }
}